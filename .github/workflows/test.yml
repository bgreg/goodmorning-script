name: Test Suite

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check zsh version
      run: zsh --version

    - name: Install dependencies
      run: |
        brew install jq figlet shellspec

    - name: Syntax check (zsh -n)
      run: |
        for f in goodmorning.sh setup.sh lib/*.sh; do
          echo "Checking $f..."
          zsh -n "$f"
        done

    - name: Check line endings (no CRLF)
      run: |
        if grep -rIl $'\r' *.sh lib/*.sh 2>/dev/null; then
          echo "Error: Found CRLF line endings"
          exit 1
        fi
        echo "All files have Unix line endings"

    - name: Check executable permissions
      run: |
        for f in goodmorning.sh setup.sh; do
          if [ ! -x "$f" ]; then
            echo "Error: $f is not executable"
            exit 1
          fi
        done
        echo "All main scripts are executable"

    - name: Security scan (no secrets)
      run: |
        if grep -rE "(api_key|password|secret|token)\s*=\s*['\"][^'\"]+['\"]" --include="*.sh" . 2>/dev/null | grep -vE "example|sample|placeholder|DEMO_KEY|\\\$\{"; then
          echo "Warning: Possible hardcoded secrets found"
          exit 1
        fi
        echo "No hardcoded secrets detected"

    - name: Check for unwanted files
      run: |
        FOUND=0

        # Log files
        if find . -name "*.log" -not -path "./.git/*" | grep -q .; then
          echo "Error: Found .log files"
          find . -name "*.log" -not -path "./.git/*"
          FOUND=1
        fi

        # macOS metadata
        if find . -name ".DS_Store" -not -path "./.git/*" | grep -q .; then
          echo "Error: Found .DS_Store files"
          find . -name ".DS_Store" -not -path "./.git/*"
          FOUND=1
        fi

        # Backup files
        if find . \( -name "*.bak" -o -name "*~" -o -name "*.swp" -o -name "*.swo" \) -not -path "./.git/*" | grep -q .; then
          echo "Error: Found backup/swap files"
          find . \( -name "*.bak" -o -name "*~" -o -name "*.swp" -o -name "*.swo" \) -not -path "./.git/*"
          FOUND=1
        fi

        # Private keys
        if find . \( -name "*.pem" -o -name "*.key" -o -name "id_rsa*" -o -name "id_ed25519*" \) -not -path "./.git/*" | grep -q .; then
          echo "Error: Found private key files"
          find . \( -name "*.pem" -o -name "*.key" -o -name "id_rsa*" -o -name "id_ed25519*" \) -not -path "./.git/*"
          FOUND=1
        fi

        # Environment files with secrets
        if [ -f ".env" ] && grep -qE "^[A-Z_]+=['\"]?[^$]" .env 2>/dev/null; then
          echo "Error: Found .env with hardcoded values"
          FOUND=1
        fi

        if [ $FOUND -eq 1 ]; then
          exit 1
        fi
        echo "No unwanted files found"

    - name: Check for personal info leaks
      run: |
        FOUND=0

        # Hardcoded home paths with usernames (but allow $HOME and ~)
        if grep -rE "/Users/[a-zA-Z0-9_]+/|/home/[a-zA-Z0-9_]+/" --include="*.sh" . 2>/dev/null | grep -v "runner"; then
          echo "Warning: Found hardcoded user home paths"
          grep -rE "/Users/[a-zA-Z0-9_]+/|/home/[a-zA-Z0-9_]+/" --include="*.sh" . | grep -v "runner"
          FOUND=1
        fi

        # Email addresses (except placeholder/example/test)
        if grep -rE "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" --include="*.sh" . 2>/dev/null | grep -vE "example|placeholder|noreply|test\.com|spec/"; then
          echo "Warning: Found email addresses"
          grep -rE "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" --include="*.sh" . | grep -vE "example|placeholder|noreply|test\.com|spec/"
          FOUND=1
        fi

        if [ $FOUND -eq 1 ]; then
          exit 1
        fi
        echo "No personal info leaks detected"

    - name: Run specs
      run: shellspec
